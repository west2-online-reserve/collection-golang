## 任务截图
![](task.png)

## 发布说明

- 0.3.0 - 2025-10-10
  - 写入数据库
  - 整理项目结构

- 0.2.0 - 2025-10-09  
  - 子评论爬取
  - 一次性爬取所有评论

- 0.1.0 - 2025-10-08  
  初版。
  - 最基本的用户名+评论爬取（控制台打印）
  - 分页爬取
  - 无需cookie

## 技术细节
不同于document页面爬取，b站评论爬的是json。

### 评论的json结构

一个评论，无论是主评论还是子评论，都是同一个json结构。如：

```json
{
  "rpid": 104560010768,
  "oid": 420981979,
  "type": 1,
  "mid": 676054748,
  "root": 0,
  "parent": 0,
  "dialog": 0,
  "count": 55,
  "rcount": 52,
  "state": 0,
  "fansgrade": 0,
  "attr": 0,
  "ctime": 1646496738,
  "mid_str": "676054748",
  "oid_str": "420981979",
  "rpid_str": "104560010768",
  "root_str": "0",
  "parent_str": "0",
  "dialog_str": "0",
  "like": 867,
  "action": 0,
  "member": {
    "mid": "676054748",
    "uname": "账号已注销",
    "sex": "保密",
    "sign": "",
    "avatar": "https://i0.hdslb.com/bfs/face/member/noface.jpg",
    "rank": "5000",
    // ...
  },
  "content": {
    "message": "在下15岁中学生，刚刚入门编程，首先，我真的想对稚晖君说句谢谢，假如没有他，我大概都不知道自己真正喜欢什么东西，当我第一次见到这个项目的时候，就真的被深深地震撼了，原来真的有人可以强到一人顶一条流水线的地步，如此宏大的项目，四个月一百二十天就能从构思直接落地，尤其是缝葡萄那一段，我觉得up应该触动了无数个男孩子少年时候的梦想。我所最期望的，自己的模样，也无非就是如此吧。\n看到视频以后我决定了日后的发展方向，主业想做AI和软件，电子和机械自己业余时间发展。世界上从来没有所谓机械降神的天才，虽说我也不过是个刚刚入门的菜鸟，对技术上的东西确实没什么发言权，但是从大佬以前的视频明显看得出，他是靠着无限深厚的技术积累一步步走到现在的，比如从最开始的动量轮自平衡机器人，到后来的自动驾驶自行车上的变相应用，明显有一个整合发展的过程。\n有人自认为终其一生也无法赶上大佬的水平了，那好，我还年轻，就用一辈子追赶好了，人生一场总该立个志向，否则所有的风向对我们而言都是逆风。这是我的第一条评论。我愿意脚踏实地努力几十年去追上大佬的技术力，日后也打算在小破站科技区发点视频记录学习和成长。未必要和大佬走一样的发展路线，点同样的技能树，但我确实想变成up这样的人。\n总有地上的菜鸟，敢于直视鸣于岐山的彩凤。\n人大脑毕竟具有终身可塑性，若是下定决心，“不可能”之类的字眼还是慎用好了。希望读到这条卑微评论的观众，能在七年之后，再来探望一下我的账号，看看我变成了怎样的人。假如up主有幸看到这条评论，那也烦请您为我将来的发展指导一些。\n在此立誓，与诸君共勉！",
    "members": [],
    "jump_url": {},
    "max_line": 6
  },
  "replies": [...],
  "reply_control": {
    "max_line": 6,
    "sub_reply_entry_text": "共52条回复",
    "sub_reply_title_text": "相关回复共52条",
    "time_desc": "1313天前发布",
    "translation_switch": 1
  },
  // ...
}
```

其中，

- `oid`：视频id（av号）

- `rpid`（`rpid_str`）：唯一id（及其字符串形式）

- `root`（`root_str`）：父评论id（及其字符串形式）‘

- `rcount`：子评论总数

- `like`：点赞数

- `member`：用户信息

  - `mid`：uid

  - `uname`：用户名
  - `sex`：性别

- `content`：评论本身

  - `message`：内容

- `replies`：未点`展开`能显示的子评论。注意这个并不是完整的子评论列表。



### 主评论爬取

- 新版b站评论接口使用了wbi签名鉴权，需要计算`w_rid`和`wts`字段。参考了 https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/misc/sign/wbi.md



### 子评论爬取
  一个评论如果有子评论的话，子评论也将分页展示。与一级评论页相似，我们也需要发送GET请求，子评论页的url类似于：

```
https://api.bilibili.com/x/v2/reply/reply?oid=115206004939189&type=1&root=276117442416&ps=10&pn=1&web_location=333.788
```

其中

- `https://api.bilibili.com/x/v2/reply/reply`：子评论api
- `oid=115206004939189`：视频唯一oid
- `type=1`：表示视频（固定）
- `root=276117442416`：隶属于哪一个评论
- `ps=10`：每页有几个子评论（固定为10）
- `pn=1`：当前是第几页（从1开始）
- `web_location=333.788`：固定

子评论`root`值，指向它的父评论的`rpid`。每个评论都有一个`rpid`字段代表其唯一id。因此已知一个主评论，就可以拼接url来获取子评论页并请求。

子评论页的分页采用简单的page数值，即`pn`。

子评论一共有多少页呢？每个评论都有一个`rcount`字段代表它一共有几个子评论。那么就可以用 `ceil(rcount / ps)` 计算有几页，其中`ps`表示每页有几条子评论，这个值是固定的。



### 数据库对象

新建数据库`bili_comments`，两张表：`bv12341117rg`表 存放目标视频评论，`user`表 存放用户信息。

`bv12341117rg`表结构：

| 字段名    | 描述                                               | 类型            | 约束                                                         |
| --------- | -------------------------------------------------- | --------------- | ------------------------------------------------------------ |
| `Rpid`    | 评论唯一id                                         | `bigint`        | `primary key`                                                |
| `Ctime`   | 时间戳                                             | `bigint`        |                                                              |
| `Like`    | 点赞数                                             | `int`           | `not null` `default 0`                                       |
| `Message` | 评论内容                                           | `varchar(2000)` |                                                              |
| `Root`    | 指向的主评论id。仅子评论需要，主评论该字段为`null` | `bigint`        |                                                              |
| `Uid`     | 评论者uid                                          | `bigint`        | `constraint fk_uid foreign key (Uid) references user (Uid)`<small>（外键，映射到`user`表的`Uid` ）</small> |

`user`表结构：

| 字段名 | 描述    | 类型           | 约束          |
| ------ | ------- | -------------- | ------------- |
| `Uid`  | 用户uid | `bigint`       | `primary key` |
| `Name` | 用户名  | `varchar(100)` |               |
| `Sex`  | 性别    | `varchar(20)`  |               |

