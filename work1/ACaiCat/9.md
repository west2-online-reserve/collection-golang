# Bonus 4

## 这个代码实现了什么功能？
输出6个质数

## 这个代码利用了golang的什么特性？
goroutine和channel

## 这个代码相较于普通写法，是否有性能上的提升？（性能提升：求解速度更快了）
### 逻辑
先运行了一个执行generate的routine来生成数据，并传给第一个filter作为in管道，
每个filter都按照顺序存有一个质数，且in管道和out管道呈链状连接，组成一条流水线，
头部是generate，中间是filter，然后在末端输出新质数，并添加新的filter。

```text
  generate -> filter1 (prime: 2) -> filter2 (prime: 3) -> ... -> 新质数 (不会被比它小的任何质数整除)
 生成自增序列      过滤2的倍数            过滤3的倍数         末端输出质数，然后拼接新的filter(存入当前保存的质数)然后开始下一轮计算
```

### 性能
下面自己写了段应该能算是普通写法的:
```go
package main

import "fmt"

const requireCount = 99999
var primes = make([]int, 0, requireCount)

func main() {
	count := 0
	for i:=2;;i++{
		if isPrime(i){
			primes = append(primes, i)
			count ++
			fmt.Println(i)
			if count == requireCount {
				break
			}
		}
	}
}

func isPrime(num int) bool{
	for _, i := range primes{
		if num%i == 0{
			return false
		}
	}
	return true
}
```
流水线和普通写法比起来，算法复杂度是一样的，但是流水线每计算出一次质数就要增加一个goroutine和channel，
goroutine会产生上下文切换开销，channel会产生通信时的同步开销，且计算质数越多时，产生的总开销就越大，
计算多个质数时速度远远不如普通写法。

### Benchmark
#### 测试用例
```go
package main

import (
	"fmt"
	"time"
)

const requireCount = 9999

func main() {
	t1 := time.Now()
	normal()
	fmt.Println("normal:", time.Since(t1))

	t2 := time.Now()
	pipeline()
	fmt.Println("pipeline:", time.Since(t2))
}

func normal() {
	var primes = make([]int, 0, requireCount)
	isPrime := func (num int) bool{
		for _, i := range primes{
			if num%i == 0{
				return false
			}
		}
		return true
	}

	count := 0
	for i:=2;;i++{
		if isPrime(i){
			primes = append(primes, i)
			count ++
			//fmt.Println(i)
			if count == requireCount {
				break
			}
		}
	}
}




func generate(ch chan int) {
	for i := 2; ; i++ {
		ch <- i
	}
}

func filter(in chan int, out chan int, prime int) {
	for {
		num := <-in
		if num%prime != 0 {
			out <- num
		}
	}
}

func pipeline() {
	ch := make(chan int)
	go generate(ch)

	for i := 0; i < requireCount; i++ {
		prime := <-ch
		//fmt.Printf("prime:%d\n", prime)
		out := make(chan int)
		go filter(ch, out, prime)
		ch = out
	}
}
```
#### 结果
```text
normal: 102.0668ms
pipeline: 2.1800693s
```

