// Code generated by hertz generator.

package main

import (
	"log"
	"memogo/biz/dal/db"
	"memogo/biz/dal/redis"
	"memogo/pkg/middleware"

	"github.com/cloudwego/hertz/pkg/app/server"
	"github.com/hertz-contrib/swagger"
	"github.com/joho/godotenv"
	swaggerFiles "github.com/swaggo/files"
)

func main() {
	// åŠ è½½ .env æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
	if err := godotenv.Load(); err != nil {
		log.Println("Warning: .env file not found, using environment variables or defaults")
	}

	// åˆå§‹åŒ–æ•°æ®åº“
	db.Init()

	// åˆå§‹åŒ– Redisï¼ˆå¯é€‰ï¼Œå¦‚æœè¿æ¥å¤±è´¥ä¼šé™çº§åˆ°æ— ç¼“å­˜æ¨¡å¼ï¼‰
	redis.Init()

	// åˆå§‹åŒ– JWT ä¸­é—´ä»¶
	var err error
	middleware.JWTMiddleware, err = middleware.InitJWTMiddleware()
	if err != nil {
		log.Fatal("Failed to initialize JWT middleware: ", err)
	}

	h := server.Default(server.WithHostPorts(":8888"))

	// æ³¨å†Œä¸šåŠ¡è·¯ç”±
	register(h)

	// æ³¨å†Œ Swagger æ–‡æ¡£è·¯ç”±ï¼ˆä½¿ç”¨æœ¬åœ° openapi.jsonï¼‰
	url := swagger.URL("http://localhost:8888/docs/openapi.json")
	h.GET("/docs/*any", swagger.WrapHandler(swaggerFiles.Handler, url))

	// æä¾› openapi.json æ–‡ä»¶
	h.StaticFile("/docs/openapi.json", "./docs/openapi.json")

	log.Println("ğŸ“– API æ–‡æ¡£åœ°å€: http://localhost:8888/docs/index.html")
	log.Println("ğŸ“¡ API æœåŠ¡åœ°å€: http://localhost:8888")

	h.Spin()
}
